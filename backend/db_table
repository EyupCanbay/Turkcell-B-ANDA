/* * PROJE: SkillHub Veritabanı (Final Revize)
 * DEĞİŞİKLİKLER: Tüm PK'ler 'id' oldu, Video Link eklendi, İlişkiler güncellendi.
 */

-- [1. TEMİZLİK (Eski tabloları ve fonksiyonları uçur)]
DROP TRIGGER IF EXISTS trg_live_points ON QuizResults;
DROP FUNCTION IF EXISTS update_leaderboard_func;
DROP VIEW IF EXISTS vw_LiveLeaderboard;
DROP TABLE IF EXISTS Leaderboard, Badges, QuizResults, QuizQuestions, Lessons, Categories, Users CASCADE;

-- [2. TABLOLAR (DDL)]

-- [Tablo: Users]
-- [Tablo: Users] -> PASSWORD EKLENDİ
CREATE TABLE Users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL, -- Şifreler uzun (hashli) olabileceği için 255 karakter.
    city VARCHAR(50),
    university VARCHAR(100),
    skill_level VARCHAR(20) CHECK (skill_level IN ('beginner', 'intermediate', 'advanced')),
    total_points INTEGER DEFAULT 0,
    badge_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL
);

ALTER TABLE Users ADD COLUMN email VARCHAR(50);

-- [Tablo: Categories]
CREATE TABLE Categories (
    id SERIAL PRIMARY KEY, -- category_id yerine id
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    deleted_at TIMESTAMP NULL
);

-- [Tablo: Lessons]
CREATE TABLE Lessons (
    id SERIAL PRIMARY KEY, -- lesson_id yerine id
    category_id INTEGER NOT NULL,
    title VARCHAR(150) NOT NULL,
    video_url TEXT, -- YENİ EKLENDİ: Ders videosunun linki
    duration_min INTEGER CHECK (duration_min > 0),
    difficulty VARCHAR(20) CHECK (difficulty IN ('Easy', 'Medium', 'Hard')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    CONSTRAINT fk_category FOREIGN KEY (category_id) REFERENCES Categories (id) ON DELETE CASCADE
);

-- [Tablo: QuizQuestions]
CREATE TABLE QuizQuestions (
    id SERIAL PRIMARY KEY, -- question_id yerine id
    lesson_id INTEGER NOT NULL,
    question_text TEXT NOT NULL,
    correct_answer TEXT NOT NULL,
    options JSONB NOT NULL,
    deleted_at TIMESTAMP NULL,
    CONSTRAINT fk_lesson_question FOREIGN KEY (lesson_id) REFERENCES Lessons (id) ON DELETE CASCADE
);

-- [Tablo: QuizResults]
CREATE TABLE QuizResults (
    id SERIAL PRIMARY KEY, -- result_id yerine id
    user_id INTEGER NOT NULL,
    lesson_id INTEGER NOT NULL,
    score INTEGER CHECK (score >= 0 AND score <= 100),
    completed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    CONSTRAINT fk_user_result FOREIGN KEY (user_id) REFERENCES Users (id) ON DELETE CASCADE,
    CONSTRAINT fk_lesson_result FOREIGN KEY (lesson_id) REFERENCES Lessons (id) ON DELETE CASCADE
);

-- [Tablo: Badges]
CREATE TABLE Badges (
    id SERIAL PRIMARY KEY, -- badge_id yerine id
    user_id INTEGER NOT NULL,
    name VARCHAR(100) NOT NULL,
    awarded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    CONSTRAINT fk_user_badge FOREIGN KEY (user_id) REFERENCES Users (id) ON DELETE CASCADE
);

-- [Tablo: Leaderboard]
CREATE TABLE Leaderboard (
    id SERIAL PRIMARY KEY, -- Burası da id oldu
    user_id INTEGER NOT NULL UNIQUE, -- Bir kullanıcı sadece bir kere girebilir (Unique Constraint şart)
    rank INTEGER DEFAULT 0,
    total_points INTEGER NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_user_leaderboard FOREIGN KEY (user_id) REFERENCES Users (id) ON DELETE CASCADE
);

-- [3. PERFORMANS İNDEKSLERİ]
CREATE INDEX idx_users_active ON Users(id) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_points ON Users(total_points DESC);
CREATE INDEX idx_quiz_lesson ON QuizQuestions(lesson_id);
CREATE INDEX idx_users_city ON Users(city);

-- [4. OTOMASYON (TRIGGER & FUNCTION)]
CREATE OR REPLACE FUNCTION update_leaderboard_func() RETURNS TRIGGER AS $$
DECLARE
    current_user_city VARCHAR(50);
    new_total_points INTEGER;
BEGIN
    -- A. Kullanıcının puanını artır (Users tablosundaki id'ye göre)
    UPDATE Users SET total_points = total_points + NEW.score 
    WHERE id = NEW.user_id 
    RETURNING total_points, city INTO new_total_points, current_user_city;

    -- B. Leaderboard güncelle (UPSERT)
    INSERT INTO Leaderboard (user_id, total_points, city, updated_at, rank)
    VALUES (NEW.user_id, new_total_points, current_user_city, NOW(), 0)
    ON CONFLICT (user_id) -- user_id unique olduğu için çakışmada update yapar
    DO UPDATE SET total_points = EXCLUDED.total_points, updated_at = NOW();
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_live_points
AFTER INSERT ON QuizResults
FOR EACH ROW EXECUTE FUNCTION update_leaderboard_func();

-- [5. VIEW GÜNCELLEMESİ]
CREATE OR REPLACE VIEW vw_LiveLeaderboard AS
SELECT u.id as user_id, u.name, RANK() OVER (ORDER BY u.total_points DESC) as live_rank, u.total_points, u.city
FROM Users u WHERE u.deleted_at IS NULL;


